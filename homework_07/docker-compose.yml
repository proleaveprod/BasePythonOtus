services:
    app:
        container_name: homework_07_app
        build:
            context: .  # Сборка из текущей директории
            
            dockerfile: characters-app/Dockerfile  # Путь к Dockerfile
            
        env_file:
            - .env  # Переменные окружения из .env
        
        ports:
            - "8000:8000"

        command: >
            sh -c "python manage.py migrate && python manage.py generate_test_data && python manage.py runserver 0.0.0.0:8000"
             
        depends_on:
            pg:
                condition: service_healthy  # Ждём, пока БД не станет доступна
    
    pg:
        container_name: homework_07_postgres
        image: postgres:15
        env_file:
            - .env # Переменные окружения из файла .env
        volumes:
            - postgres_data:/var/lib/postgresql/data
        ports:
            - "${POSTGRES_PORT}:5432"
        
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
            interval: 2s
            timeout: 3s
            retries: 3



volumes:
    postgres_data:
        name: homework_07_volume